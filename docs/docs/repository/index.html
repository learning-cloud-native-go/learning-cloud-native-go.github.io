<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Cloud Native Go Tutorials for Everyone!">
  <meta name="author" content="Dumindu Madunuwan">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#101010" media="(prefers-color-scheme: dark)">
  

  <title>Repository ¬∑ Learning Cloud Native Go</title>
  <link rel="canonical" href="https://learning-cloud-native-go.github.io/docs/repository/">
  <link rel="stylesheet" href="/assets/css/docs.min.67fc7b3b41d707b198af1dd244ec62e1a1dd4665e40cb6f1d97e9257e597ff1d.css" integrity="">

  <link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon/favicon.ico">
<link rel="icon" href="/favicon/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="icon" href="/favicon/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png" sizes="180x180">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-H3GD0XFJ42"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-H3GD0XFJ42');
</script>
</head>

<body>

<div id="outer-wrapper">

  <div id="aside-wrapper">
    <aside>
      <div>
        <button class="btn"><i>‚ùå</i>Close</button>
      </div>
      <a href="/" class="site-logo">Learning Cloud Native Go</a>

      <nav role="navigation">
        <details open>
          <summary>Documentation</summary>
          <ul><li>
              
                
                <a class="" href="/docs/overview/">
                  
                  Overview
                  
                </a>
              
            </li>

          </ul>
        </details><details open>
          <summary>Building a Dockerized RESTful API</summary>
          <ul><li>
              
                
                <a class="" href="/docs/building-a-dockerized-restful-api-application-in-go/">
                  
                  Overview
                  
                </a>
              
            </li><li>
              
                
                <a class="" href="/docs/hello-world-server/">
                  
                  Hello World server
                  
                </a>
              
            </li><li>
              
                
                <a class="" href="/docs/database-and-migrations/">
                  
                  Database and migrations
                  
                </a>
              
            </li><li>
              
                
                <a class="" href="/docs/configurations/">
                  
                  Configurations
                  
                </a>
              
            </li><li>
              
                
                <a class="" href="/docs/routes-and-openapi-specification/">
                  
                  Routes and OpenAPI specification
                  
                </a>
              
            </li><li>
              
                
                <a class="active" href="/docs/repository/">
                  
                  Repository
                  
                </a>
              
            </li><li>
              
                
                <a class="" href="/docs/error-handling/">
                  
                  Error handling
                  
                </a>
              
            </li>

          </ul>
        </details>
      </nav>
    </aside>
  </div>

  <div id="content-wrapper">
    <header>
      <a href="/" class="site-logo">Learning Cloud Native Go</a>
    </header>

    <main>
      <article>
        <nav>
          <button class="btn"><i>‚¨ÖÔ∏è</i> On this section</button>
          <button class="btn">On this page <i>‚û°Ô∏è</i></button>
        </nav>
        <header>
          <h1>Repository</h1>
          <p></p>
        </header>
        <div id="article-body">
          <blockquote class="info"><p><strong>üë®‚Äçüè´</strong> <strong>Before we start&hellip;</strong></p>
<ul>
<li>The repository pattern is a design pattern in software development used to isolate/ abstract the data layer.</li>
<li>Go standard library provides the <a href="https://pkg.go.dev/database/sql"><code>database/sql</code></a> package to interaction with SQL databases. But there are Go libraries such as <a href="https://github.com/jmoiron/sqlx"><code>sqlx</code></a>, <a href="https://github.com/sqlc-dev/sqlc"><code>sqlc</code></a>, <a href="https://gorm.io/">GORM</a>, <a href="https://entgo.io">Ent</a> which can be a good fit for your requirements. We choose GORM because it&rsquo;s good for rapid development and to handle complex database transactions comfortably.</li>
</ul>
</blockquote>
<h2 id="adding-repository">Adding repository</h2>
<h3 id="1-add-gorm">1. Add GORM</h3>
<p>GORM is a comprehensive <a href="https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping">ORM</a> for Go. Its features include CRUD operations, querying, association handling, auto migrations, preloading, hooks, and much more. It is also compatible with various SQL databases including MySQL, PostgreSQL, SQLite, and SQL Server. Please refer to the <a href="https://gorm.io/docs/">GORM documentation</a> for more information.</p>
<p>We use a Postgres database and support database logs. So, we need to install following packages.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">get</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">io</span><span class="o">/</span><span class="nx">gorm</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">get</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">io</span><span class="o">/</span><span class="nx">driver</span><span class="o">/</span><span class="nx">postgres</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">get</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">io</span><span class="o">/</span><span class="nx">gorm</span><span class="o">/</span><span class="nx">logger</span>
</span></span></code></pre></div><h3 id="2-declare-models">2. Declare Models</h3>
<p>We need to define a Go struct that corresponds to the <a href="/docs/database-and-migrations/#database-design"><code>books</code> table</a> of our database. Since the <code>id</code> column utilizes the <code>UUID</code> data type, we have to use a Go implementation of <code>uuid</code> like <a href="https://github.com/gofrs/uuid"><code>gofrs/uuid</code></a>, <a href="https://github.com/google/uuid"><code>google/uuid</code></a> and here we use <code>google/uuid</code>.</p>
<h4 id="i-add-googleuuid">i. Add <code>google/uuid</code></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">get</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">google</span><span class="o">/</span><span class="nx">uuid</span>
</span></span></code></pre></div><h4 id="ii-update-apiresourcebookmodelgo">ii. Update <code>api/resource/book/model.go</code></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/google/uuid&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;gorm.io/gorm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Book</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ID</span>            <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span> <span class="s">`gorm:&#34;primarykey&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Title</span>         <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Author</span>        <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">PublishedDate</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ImageURL</span>      <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Description</span>   <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">CreatedAt</span>     <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="cl">	<span class="nx">UpdatedAt</span>     <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="cl">	<span class="nx">DeletedAt</span>     <span class="nx">gorm</span><span class="p">.</span><span class="nx">DeletedAt</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Books</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Book</span>
</span></span></code></pre></div><h3 id="3-implement-repository-functions">3. Implement repository functions</h3>
<p>Let&rsquo;s add repository functions under <code>api/resource/book/repository.go</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">book</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/google/uuid&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;gorm.io/gorm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Repository</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewRepository</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="o">*</span><span class="nx">Repository</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Repository</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">db</span><span class="p">:</span> <span class="nx">db</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Repository</span><span class="p">)</span> <span class="nf">List</span><span class="p">()</span> <span class="p">(</span><span class="nx">Books</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">books</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">Book</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">books</span><span class="p">).</span><span class="nx">Error</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">books</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Repository</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">book</span> <span class="o">*</span><span class="nx">Book</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Book</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">book</span><span class="p">).</span><span class="nx">Error</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">book</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Repository</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">id</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Book</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">book</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Book</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;id = ?&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nf">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">book</span><span class="p">).</span><span class="nx">Error</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">book</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Repository</span><span class="p">)</span> <span class="nf">Update</span><span class="p">(</span><span class="nx">book</span> <span class="o">*</span><span class="nx">Book</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">result</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Model</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Book</span><span class="p">{}).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Select</span><span class="p">(</span><span class="s">&#34;Title&#34;</span><span class="p">,</span> <span class="s">&#34;Author&#34;</span><span class="p">,</span> <span class="s">&#34;PublishedDate&#34;</span><span class="p">,</span> <span class="s">&#34;ImageURL&#34;</span><span class="p">,</span> <span class="s">&#34;Description&#34;</span><span class="p">,</span> <span class="s">&#34;UpdatedAt&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Where</span><span class="p">(</span><span class="s">&#34;id = ?&#34;</span><span class="p">,</span> <span class="nx">book</span><span class="p">.</span><span class="nx">ID</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">Updates</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">RowsAffected</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Repository</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">id</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">UUID</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">result</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="s">&#34;id = ?&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nf">Delete</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Book</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">RowsAffected</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>üí° Refer <a href="https://gorm.io/docs/">GORM documentation</a> for more information.</p>
<h2 id="testing-repository">Testing repository</h2>
<p>First, we will create a helper package for tests, to test code concise and focused by reducing the amount of repeated assert-like code. We use <a href="https://github.com/DATA-DOG/go-sqlmock">DATA-DOG/go-sqlmock</a> to create unit tests without relying on an actual database connection. As each repository test function requires a mock database connection, we will add a mock DB helper under <code>mock/db</code> package. Then, we can write our tests more concisely.</p>
<h3 id="1-add-test-helper">1. Add test helper</h3>
<ul>
<li>Add <code>util/test/test.go</code></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">test</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;err: %e&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nx">Equal</span><span class="p">[</span><span class="nx">T</span> <span class="nx">comparable</span><span class="p">](</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">x</span> <span class="o">!=</span> <span class="nx">y</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;not equal: %v, %v&#34;</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="2-add-data-doggo-sqlmock">2. Add <code>DATA-DOG/go-sqlmock</code></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="nx">get</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">DATA</span><span class="o">-</span><span class="nx">DOG</span><span class="o">/</span><span class="k">go</span><span class="o">-</span><span class="nx">sqlmock</span> 
</span></span></code></pre></div><h3 id="3-add-mock-db">3. Add Mock DB</h3>
<p>Let&rsquo;s add the mock database factory function under <code>mock/db/db.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">db</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;database/sql/driver&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/DATA-DOG/go-sqlmock&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;gorm.io/driver/postgres&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;gorm.io/gorm&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewMockDB</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nx">Sqlmock</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">gdb</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">postgres</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">postgres</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Conn</span><span class="p">:</span> <span class="nx">db</span><span class="p">}),</span> <span class="o">&amp;</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">Config</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">gdb</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">AnyTime</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">AnyTime</span><span class="p">)</span> <span class="nf">Match</span><span class="p">(</span><span class="nx">v</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ok</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>üí°<code>AnyTime</code> will be used to check if a parameter is of the <code>time.Time</code> type. Refer, <a href="https://github.com/DATA-DOG/go-sqlmock#matching-arguments-like-timetime">&ldquo;Matching arguments like <code>time.Time</code>&rdquo;</a></p>
<h3 id="4-write-repository-tests">4. Write repository tests</h3>
<p>Let&rsquo;s write repository tests under <code>api/resource/book/repository_test.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">book_test</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/DATA-DOG/go-sqlmock&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/google/uuid&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;myapp/api/resource/book&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mockDB</span> <span class="s">&#34;myapp/mock/db&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span> <span class="s">&#34;myapp/util/test&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestRepository_List</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nf">Parallel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nf">NewMockDB</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">repo</span> <span class="o">:=</span> <span class="nx">book</span><span class="p">.</span><span class="nf">NewRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">mockRows</span> <span class="o">:=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">,</span> <span class="s">&#34;author&#34;</span><span class="p">}).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">AddRow</span><span class="p">(</span><span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">(),</span> <span class="s">&#34;Book1&#34;</span><span class="p">,</span> <span class="s">&#34;Author1&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">AddRow</span><span class="p">(</span><span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">(),</span> <span class="s">&#34;Book2&#34;</span><span class="p">,</span> <span class="s">&#34;Author2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;^SELECT (.+) FROM \&#34;books\&#34;&#34;</span><span class="p">).</span><span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">mockRows</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">books</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">repo</span><span class="p">.</span><span class="nf">List</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">books</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestRepository_Create</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nf">Parallel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nf">NewMockDB</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">repo</span> <span class="o">:=</span> <span class="nx">book</span><span class="p">.</span><span class="nf">NewRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">id</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectBegin</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;^INSERT INTO \&#34;books\&#34; &#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithArgs</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#34;Title&#34;</span><span class="p">,</span> <span class="s">&#34;Author&#34;</span><span class="p">,</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nx">AnyTime</span><span class="p">{},</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nx">AnyTime</span><span class="p">{},</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nx">AnyTime</span><span class="p">{},</span> <span class="kc">nil</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectCommit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">book</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">book</span><span class="p">.</span><span class="nx">Book</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">Title</span><span class="p">:</span> <span class="s">&#34;Title&#34;</span><span class="p">,</span> <span class="nx">Author</span><span class="p">:</span> <span class="s">&#34;Author&#34;</span><span class="p">,</span> <span class="nx">PublishedDate</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">repo</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestRepository_Read</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nf">Parallel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nf">NewMockDB</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">repo</span> <span class="o">:=</span> <span class="nx">book</span><span class="p">.</span><span class="nf">NewRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">id</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mockRows</span> <span class="o">:=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">,</span> <span class="s">&#34;author&#34;</span><span class="p">}).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">AddRow</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#34;Book1&#34;</span><span class="p">,</span> <span class="s">&#34;Author1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;^SELECT (.+) FROM \&#34;books\&#34; WHERE (.+)&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithArgs</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">mockRows</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">book</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">repo</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="s">&#34;Book1&#34;</span><span class="p">,</span> <span class="nx">book</span><span class="p">.</span><span class="nx">Title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestRepository_Update</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nf">Parallel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nf">NewMockDB</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">repo</span> <span class="o">:=</span> <span class="nx">book</span><span class="p">.</span><span class="nf">NewRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">id</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">,</span> <span class="s">&#34;author&#34;</span><span class="p">}).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">AddRow</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#34;Book1&#34;</span><span class="p">,</span> <span class="s">&#34;Author1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectBegin</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;^UPDATE \&#34;books\&#34; SET&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithArgs</span><span class="p">(</span><span class="s">&#34;Title&#34;</span><span class="p">,</span> <span class="s">&#34;Author&#34;</span><span class="p">,</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nx">AnyTime</span><span class="p">{},</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nx">AnyTime</span><span class="p">{},</span> <span class="nx">id</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectCommit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">book</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">book</span><span class="p">.</span><span class="nx">Book</span><span class="p">{</span><span class="nx">ID</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">Title</span><span class="p">:</span> <span class="s">&#34;Title&#34;</span><span class="p">,</span> <span class="nx">Author</span><span class="p">:</span> <span class="s">&#34;Author&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">repo</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestRepository_Delete</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nf">Parallel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mockDB</span><span class="p">.</span><span class="nf">NewMockDB</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">repo</span> <span class="o">:=</span> <span class="nx">book</span><span class="p">.</span><span class="nf">NewRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">id</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="p">=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">,</span> <span class="s">&#34;author&#34;</span><span class="p">}).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">AddRow</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#34;Book1&#34;</span><span class="p">,</span> <span class="s">&#34;Author1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectBegin</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;^UPDATE \&#34;books\&#34; SET \&#34;deleted_at\&#34;&#34;</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WithArgs</span><span class="p">(</span><span class="nx">mockDB</span><span class="p">.</span><span class="nx">AnyTime</span><span class="p">{},</span> <span class="nx">id</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectCommit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">repo</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">testUtil</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">rows</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="adding-the-repository-to-the-api">Adding the repository to the API</h2>
<h3 id="1-add-repository-as-an-api-dependency">1. Add repository as an API dependency</h3>
<p>Let&rsquo;s add the repository as a dependency for <code>API struct</code> in <code>api/resource/book/handler.go</code>. In addition to that we create the factory <code>func New(db *gorm.DB) *API</code> to create the API from router, and then we need to update <code>cmd/api/main.go</code> to open a database connection from the <code>main func</code> and pass it to router.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;gorm.io/gorm&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">API</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">repository</span> <span class="o">*</span><span class="nx">Repository</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="o">*</span><span class="nx">API</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">API</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">repository</span><span class="p">:</span> <span class="nf">NewRepository</span><span class="p">(</span><span class="nx">db</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="2-update-router">2. Update router</h3>
<p>Let&rsquo;s  update <code>api/router/router.go</code> to call the <code>API</code> factory function with a <code>db *gorm.DB</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">router</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/go-chi/chi/v5&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;gorm.io/gorm&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;myapp/api/resource/book&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;myapp/api/resource/health&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span> <span class="o">*</span><span class="nx">chi</span><span class="p">.</span><span class="nx">Mux</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">chi</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/livez&#34;</span><span class="p">,</span> <span class="nx">health</span><span class="p">.</span><span class="nx">Read</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">.</span><span class="nf">Route</span><span class="p">(</span><span class="s">&#34;/v1&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="nx">chi</span><span class="p">.</span><span class="nx">Router</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">bookAPI</span> <span class="o">:=</span> <span class="nx">book</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/books&#34;</span><span class="p">,</span> <span class="nx">bookAPI</span><span class="p">.</span><span class="nx">List</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">&#34;/books&#34;</span><span class="p">,</span> <span class="nx">bookAPI</span><span class="p">.</span><span class="nx">Create</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;/books/{id}&#34;</span><span class="p">,</span> <span class="nx">bookAPI</span><span class="p">.</span><span class="nx">Read</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="s">&#34;/books/{id}&#34;</span><span class="p">,</span> <span class="nx">bookAPI</span><span class="p">.</span><span class="nx">Update</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="s">&#34;/books/{id}&#34;</span><span class="p">,</span> <span class="nx">bookAPI</span><span class="p">.</span><span class="nx">Delete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">r</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="3-update-cmdapimaingo">3. Update <code>cmd/api/main.go</code></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;gorm.io/driver/postgres&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;gorm.io/gorm&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">gormlogger</span> <span class="s">&#34;gorm.io/gorm/logger&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;myapp/api/router&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;myapp/config&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">fmtDBString</span> <span class="p">=</span> <span class="s">&#34;host=%s user=%s password=%s dbname=%s port=%d sslmode=disable&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">logLevel</span> <span class="nx">gormlogger</span><span class="p">.</span><span class="nx">LogLevel</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nx">Debug</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logLevel</span> <span class="p">=</span> <span class="nx">gormlogger</span><span class="p">.</span><span class="nx">Info</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">logLevel</span> <span class="p">=</span> <span class="nx">gormlogger</span><span class="p">.</span><span class="nx">Error</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">dbString</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">fmtDBString</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nx">DBName</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nx">Port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gorm</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">postgres</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">dbString</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">gorm</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Logger</span><span class="p">:</span> <span class="nx">gormlogger</span><span class="p">.</span><span class="nx">Default</span><span class="p">.</span><span class="nf">LogMode</span><span class="p">(</span><span class="nx">logLevel</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;DB connection start failure&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">router</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Addr</span><span class="p">:</span>         <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;:%d&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nx">Port</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Handler</span><span class="p">:</span>      <span class="nx">r</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ReadTimeout</span><span class="p">:</span>  <span class="nx">c</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nx">TimeoutRead</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">WriteTimeout</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nx">TimeoutWrite</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IdleTimeout</span><span class="p">:</span>  <span class="nx">c</span><span class="p">.</span><span class="nx">Server</span><span class="p">.</span><span class="nx">TimeoutIdle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Starting server &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ErrServerClosed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;Server startup failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="4-run-go-mod-tidy">4. Run <code>go mod tidy</code></h3>
<p>When we add a new package and use it, we have to run <code>go mod tidy</code> to reorganize the dependencies in the <code>go.mod</code> file.</p>
<h2 id="using-repository-from-handlers">Using repository from handlers</h2>
<p>Let&rsquo;s start coding handlers in <code>api/resource/book/handler.go</code>.</p>
<h3 id="1-add-helper-functions">1. Add helper functions</h3>
<p>Currently, in <code>api/resource/book/model.go</code>, we have the <code>Form</code>, <code>Book</code> and <code>DTO</code> structs. But the <code>Form</code> needs to be converted to <code>Book</code> model to save in the database. Also, the <code>Book</code> needs to be converted to <code>DTO</code> to show to the end user.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">Form</span><span class="p">)</span> <span class="nf">ToModel</span><span class="p">()</span> <span class="o">*</span><span class="nx">Book</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pubDate</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">&#34;2006-01-02&#34;</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nx">PublishedDate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Book</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Title</span><span class="p">:</span>         <span class="nx">f</span><span class="p">.</span><span class="nx">Title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Author</span><span class="p">:</span>        <span class="nx">f</span><span class="p">.</span><span class="nx">Author</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">PublishedDate</span><span class="p">:</span> <span class="nx">pubDate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ImageURL</span><span class="p">:</span>      <span class="nx">f</span><span class="p">.</span><span class="nx">ImageURL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Description</span><span class="p">:</span>   <span class="nx">f</span><span class="p">.</span><span class="nx">Description</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Book</span><span class="p">)</span> <span class="nf">ToDto</span><span class="p">()</span> <span class="o">*</span><span class="nx">DTO</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">DTO</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ID</span><span class="p">:</span>            <span class="nx">b</span><span class="p">.</span><span class="nx">ID</span><span class="p">.</span><span class="nf">String</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Title</span><span class="p">:</span>         <span class="nx">b</span><span class="p">.</span><span class="nx">Title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Author</span><span class="p">:</span>        <span class="nx">b</span><span class="p">.</span><span class="nx">Author</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">PublishedDate</span><span class="p">:</span> <span class="nx">b</span><span class="p">.</span><span class="nx">PublishedDate</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006-01-02&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ImageURL</span><span class="p">:</span>      <span class="nx">b</span><span class="p">.</span><span class="nx">ImageURL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Description</span><span class="p">:</span>   <span class="nx">b</span><span class="p">.</span><span class="nx">Description</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">bs</span> <span class="nx">Books</span><span class="p">)</span> <span class="nf">ToDto</span><span class="p">()</span> <span class="p">[]</span><span class="o">*</span><span class="nx">DTO</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dtos</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">DTO</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">bs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">bs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dtos</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">ToDto</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">dtos</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="2-list">2. List</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">API</span><span class="p">)</span> <span class="nf">List</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">books</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nf">List</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">books</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprint</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;[]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">books</span><span class="p">.</span><span class="nf">ToDto</span><span class="p">());</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="3-create">3. Create</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">API</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">form</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Form</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">newBook</span> <span class="o">:=</span> <span class="nx">form</span><span class="p">.</span><span class="nf">ToModel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">newBook</span><span class="p">.</span><span class="nx">ID</span> <span class="p">=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">newBook</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusCreated</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="4-read">4. Read</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">API</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">chi</span><span class="p">.</span><span class="nf">URLParam</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="s">&#34;id&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">book</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">gorm</span><span class="p">.</span><span class="nx">ErrRecordNotFound</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">dto</span> <span class="o">:=</span> <span class="nx">book</span><span class="p">.</span><span class="nf">ToDto</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">dto</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="5-update">5. Update</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">API</span><span class="p">)</span> <span class="nf">Update</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">chi</span><span class="p">.</span><span class="nf">URLParam</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="s">&#34;id&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">form</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Form</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">book</span> <span class="o">:=</span> <span class="nx">form</span><span class="p">.</span><span class="nf">ToModel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">book</span><span class="p">.</span><span class="nx">ID</span> <span class="p">=</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">rows</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="6-delete">6. Delete</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">API</span><span class="p">)</span> <span class="nf">Delete</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">chi</span><span class="p">.</span><span class="nf">URLParam</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="s">&#34;id&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">repository</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// handle later
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">rows</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotFound</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>üí°Now, you can test the APIs via the Open-API specification we generated in the previous section.</p>
</blockquote>
<h2 id="-final-project-structure">üìÅ Final project structure</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">myapp
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ cmd
</span></span><span class="line"><span class="cl">‚îÇ  ‚îú‚îÄ‚îÄ api
</span></span><span class="line"><span class="cl">‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ main.go
</span></span><span class="line"><span class="cl">‚îÇ  ‚îî‚îÄ‚îÄ migrate
</span></span><span class="line"><span class="cl">‚îÇ     ‚îî‚îÄ‚îÄ main.go
</span></span><span class="line"><span class="cl">‚îÇ
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ api
</span></span><span class="line"><span class="cl">‚îÇ  ‚îú‚îÄ‚îÄ router
</span></span><span class="line"><span class="cl">‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ router.go
</span></span><span class="line"><span class="cl">‚îÇ  ‚îÇ
</span></span><span class="line"><span class="cl">‚îÇ  ‚îî‚îÄ‚îÄ resource
</span></span><span class="line"><span class="cl">‚îÇ     ‚îú‚îÄ‚îÄ health
</span></span><span class="line"><span class="cl">‚îÇ     ‚îÇ  ‚îî‚îÄ‚îÄ handler.go
</span></span><span class="line"><span class="cl">‚îÇ     ‚îú‚îÄ‚îÄ book
</span></span><span class="line"><span class="cl">‚îÇ     ‚îÇ  ‚îú‚îÄ‚îÄ handler.go
</span></span><span class="line"><span class="cl">‚îÇ     ‚îÇ  ‚îú‚îÄ‚îÄ model.go
</span></span><span class="line"><span class="cl">‚îÇ     ‚îÇ  ‚îú‚îÄ‚îÄ repository.go
</span></span><span class="line"><span class="cl">‚îÇ     ‚îÇ  ‚îî‚îÄ‚îÄ repository_test.go
</span></span><span class="line"><span class="cl">‚îÇ     ‚îî‚îÄ‚îÄ common
</span></span><span class="line"><span class="cl">‚îÇ        ‚îî‚îÄ‚îÄ err
</span></span><span class="line"><span class="cl">‚îÇ           ‚îî‚îÄ‚îÄ err.go
</span></span><span class="line"><span class="cl">‚îÇ
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ migrations
</span></span><span class="line"><span class="cl">‚îÇ  ‚îî‚îÄ‚îÄ 00001_create_books_table.sql
</span></span><span class="line"><span class="cl">‚îÇ
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ config
</span></span><span class="line"><span class="cl">‚îÇ  ‚îî‚îÄ‚îÄ config.go
</span></span><span class="line"><span class="cl">‚îÇ
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ .env
</span></span><span class="line"><span class="cl">‚îÇ
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ go.mod
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ go.sum
</span></span><span class="line"><span class="cl">‚îÇ
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ mock
</span></span><span class="line"><span class="cl">‚îÇ  ‚îî‚îÄ‚îÄ db
</span></span><span class="line"><span class="cl">‚îÇ     ‚îî‚îÄ‚îÄ db.go
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ util
</span></span><span class="line"><span class="cl">‚îÇ  ‚îî‚îÄ‚îÄ <span class="nb">test</span>
</span></span><span class="line"><span class="cl">‚îÇ     ‚îî‚îÄ‚îÄ test.go
</span></span><span class="line"><span class="cl">‚îÇ
</span></span><span class="line"><span class="cl">‚îú‚îÄ‚îÄ docker-compose.yml
</span></span><span class="line"><span class="cl">‚îî‚îÄ‚îÄ Dockerfile
</span></span></code></pre></div><h2 id="-whats-next">üë®‚Äçüè´ What&rsquo;s next‚Ä¶</h2>
<p>In the next article, we‚Äôll add the error handing and the validator to our application.</p>

        </div>

        <footer>
          

          
          
          
          

          
          
          
          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          
          
          

          <time datetime="2023-10-22"><i>üïí</i> Updated: 2023-10-22</time>
          
          <a href="/docs/routes-and-openapi-specification/"><i>Ôπ§</i> Previous</a>
          

          
          <a href="/docs/error-handling/">Next <i>Ôπ•</i></a>
          

        </footer>
      </article>

      <aside>
        <div>
          <button class="btn"><i>‚ùå</i>Close</button>
        </div>
        <strong>On this page</strong>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#adding-repository">Adding repository</a>
      <ul>
        <li><a href="#1-add-gorm">1. Add GORM</a></li>
        <li><a href="#2-declare-models">2. Declare Models</a></li>
        <li><a href="#3-implement-repository-functions">3. Implement repository functions</a></li>
      </ul>
    </li>
    <li><a href="#testing-repository">Testing repository</a>
      <ul>
        <li><a href="#1-add-test-helper">1. Add test helper</a></li>
        <li><a href="#2-add-data-doggo-sqlmock">2. Add <code>DATA-DOG/go-sqlmock</code></a></li>
        <li><a href="#3-add-mock-db">3. Add Mock DB</a></li>
        <li><a href="#4-write-repository-tests">4. Write repository tests</a></li>
      </ul>
    </li>
    <li><a href="#adding-the-repository-to-the-api">Adding the repository to the API</a>
      <ul>
        <li><a href="#1-add-repository-as-an-api-dependency">1. Add repository as an API dependency</a></li>
        <li><a href="#2-update-router">2. Update router</a></li>
        <li><a href="#3-update-cmdapimaingo">3. Update <code>cmd/api/main.go</code></a></li>
        <li><a href="#4-run-go-mod-tidy">4. Run <code>go mod tidy</code></a></li>
      </ul>
    </li>
    <li><a href="#using-repository-from-handlers">Using repository from handlers</a>
      <ul>
        <li><a href="#1-add-helper-functions">1. Add helper functions</a></li>
        <li><a href="#2-list">2. List</a></li>
        <li><a href="#3-create">3. Create</a></li>
        <li><a href="#4-read">4. Read</a></li>
        <li><a href="#5-update">5. Update</a></li>
        <li><a href="#6-delete">6. Delete</a></li>
      </ul>
    </li>
    <li><a href="#-final-project-structure">üìÅ Final project structure</a></li>
    <li><a href="#-whats-next">üë®‚Äçüè´ What&rsquo;s next‚Ä¶</a></li>
  </ul>
</nav>
      </aside>
    </main>

    <footer>
      <div><i>üßë‚Äçüíª</i>Built by and copyright<a href="https://github.com/dumindu" target="_blank">Dumindu Madunuwan</a><i>üìÖ</i> 2019-2024<i>üöÄ</i> <a href="https://github.com/learning-cloud-native-go" target="_blank">GitHub</a></div>
      <div>
        <button class="btn"><i>‚òÄÔ∏è</i><i>‚ÅÑ</i><i>üåë</i></button>
      </div>
    </footer>
  </div>

</div>

<div id="body-model-outer"></div>
<script type="text/javascript" src="/assets/js/docs.min.12ffdc25c0149ef34e761ee54587f2aae17affcb8375298ad2180851930cb142.js" integrity=""></script>
</body>
</html>